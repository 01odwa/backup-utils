#!/usr/bin/env bash
#/ usage: ghe-backup-mysql <host>
#/ backup mysql from a github instance.
#/
#/ note: this script typically isn't called directly. it's invoked by the
#/ ghe-backup command.
set -e

# Bring in the backup configuration
# shellcheck source=share/github-backup-utils/ghe-backup-config
. "$( dirname "${BASH_SOURCE[0]}" )/ghe-backup-config"

bm_start "$(basename $0)"

# Perform a host-check and establish the remote version in GHE_REMOTE_VERSION.
ghe_remote_version_required "$GHE_HOSTNAME"

if is_external_database_target; then
  echo "Backing up external MySQL database using customer-provided script..."
  if [ -n "$EXTERNAL_DATABASE_BACKUP_SCRIPT" ]; then
    $EXTERNAL_DATABASE_BACKUP_SCRIPT
  else
    if is_binary_backup_feature_on
      echo "Error: Binary backup is not supported with an external MySQL database. 
      Please provide a custom backup script using EXTERNAL_DATABASE_BACKUP_SCRIPT"
      exit 1
    fi
  fi
fi

if is_binary_backup_feature_on; then
  ghe-backup-mysql-binary
else
  ghe-backup-mysql-logical
fi

bm_end "$(basename $0)"
