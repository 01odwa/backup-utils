#!/usr/bin/env bash
# Usage: ghe-restore-external-database-check
# GitHub Enterprise checks for external-database related restores.

# Bring in the backup configuration
# shellcheck source=share/github-backup-utils/ghe-backup-config
. "$( dirname "${BASH_SOURCE[0]}" )/ghe-backup-config"

# Check if there are MySQL nodes in the target environment
if $RESTORE_SETTINGS && internal_database_snapshot_to_external_database; then
  if ghe-ssh "$GHE_HOSTNAME" "test -f $GHE_REMOTE_CLUSTER_CONF_FILE"; then
    mysql_nodes=$(ghe-ssh "$GHE_HOSTNAME" "ghe-cluster-each -u -r mysql")

    if [ -z "$mysql_nodes" ]; then
      # Restoring a non external DB snapshot to a internal snapshot
      # requires that the target environment has a mysql-server
      # configured.
      echo "Error: Target environment does not have a node with mysql-server role. Aborting restore."
      exit 1
    fi
  fi
fi

# User should remove the `mysql-server` role after the fact.
if $RESTORE_SETTINGS && external_database_snapshot_to_internal_database; then
  if ghe-ssh "$GHE_HOSTNAME" "test -f $GHE_REMOTE_CLUSTER_CONF_FILE"; then
    mysql_nodes=$(ghe-ssh "$GHE_HOSTNAME" "ghe-cluster-each -u -r mysql")

    if [ -n "$mysql_nodes" ]; then
      echo "Warning: Target environment has mysql-server role. This should be removed post-restore."
      exit 0
    fi
  fi
fi

if ! check_external_db_compatibility; then
  exit 1
fi